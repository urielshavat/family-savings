<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>××—×©×‘×•×Ÿ ×—×™×¡×›×•×Ÿ ××©×¤×—×ª×™ | ×ª×›× ×•×Ÿ ×¤×™× × ×¡×™ ×—×›×</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
      body { 
        font-family: 'Heebo', sans-serif; 
        background-color: #f8fafc;
        color: #1e293b;
      }
      .glass {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      .card-shadow {
        box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
      }
      .btn-primary {
        background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px -10px rgba(16, 185, 129, 0.5);
      }
      input, select {
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      input:focus, select:focus {
        border-color: #10b981;
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
      }
      @keyframes slideIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-slide-in {
        animation: slideIn 0.3s ease-out forwards;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: #f1f5f9; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>

    <!-- Fixed Babel Standalone Version -->
    <script src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.3.1",
        "react-dom": "https://esm.sh/react-dom@18.3.1",
        "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
        "lucide-react": "https://esm.sh/lucide-react@0.460.0?deps=react@18.3.1",
        "recharts": "https://esm.sh/recharts@2.13.0?deps=react@18.3.1,react-dom@18.3.1"
      }
    }
    </script>
  </head>
  <body class="overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react,typescript">
      import React, { useState, useCallback, useRef, useMemo } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        Settings, Percent, Calendar, DollarSign, Activity, Plus, 
        Trash2, CalendarCheck, Calculator, Download, 
        Upload, TrendingUp, Wallet, Sparkles, PieChart, Info, AlertCircle, ChevronDown, Clock
      } from 'lucide-react';
      import { 
        AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, 
        ResponsiveContainer, ReferenceLine
      } from 'recharts';

      // --- UTILS ---
      const addMonths = (date, months) => {
        const d = new Date(date);
        d.setMonth(d.getMonth() + months);
        return d;
      };

      const formatDate = (date) => {
        return new Intl.DateTimeFormat('he-IL', { month: 'short', year: 'numeric' }).format(date);
      };

      const getMonthlyRate = (annualRate) => Math.pow(1 + annualRate / 100, 1 / 12) - 1;

      const generateId = () => crypto.randomUUID?.() || Math.random().toString(36).substring(2, 11);

      const formatCurrency = (v) => new Intl.NumberFormat('he-IL', { 
        style: 'currency', 
        currency: 'ILS', 
        maximumFractionDigits: 0 
      }).format(v);

      // --- SIMULATION ENGINE ---
      const runSimulationPeriod = (
        startBalance,
        startCostBasis, 
        startNominalBasis,
        startDate,
        startMonthIndex,
        durationMonths,
        monthlyDeposit,
        params,
        eventsInPeriod
      ) => {
        let balance = startBalance;
        let costBasis = startCostBasis; // Indexed cost basis (for real gains tax)
        let nominalBasis = startNominalBasis; // Unindexed cost basis
        const schedule = [];
        let failed = false;

        const monthlyReturnRate = getMonthlyRate(params.annualReturn);
        const monthlyInflationRate = getMonthlyRate(params.annualInflation);
        const taxRate = params.capitalGainsTax / 100;

        for (let i = 0; i < durationMonths; i++) {
          const currentMonthIndex = startMonthIndex + i;
          const currentDate = addMonths(startDate, i);
          const balanceStart = balance;

          balance += monthlyDeposit;
          costBasis += monthlyDeposit;
          nominalBasis += monthlyDeposit;

          balance *= (1 + monthlyReturnRate);
          costBasis *= (1 + monthlyInflationRate);

          const monthEvents = eventsInPeriod.get(currentMonthIndex);
          let mGross = 0, mNet = 0, mTax = 0, mPreBal = 0, mRealProfit = 0, mNominalProfit = 0;
          let eventRef = undefined;

          if (monthEvents) {
            mPreBal = balance;
            for (const event of monthEvents) {
              eventRef = event;
              const inflationFactor = Math.pow(1 + monthlyInflationRate, currentMonthIndex);
              const targetNetNominal = event.targetAmount * inflationFactor;

              const realProfitRatio = balance > 0 ? Math.max(0, (balance - costBasis) / balance) : 0;
              const nominalProfitRatio = balance > 0 ? Math.max(0, (balance - nominalBasis) / balance) : 0;
              const effectiveTaxRate = realProfitRatio * taxRate;
              
              const grossNeeded = targetNetNominal / (1 - effectiveTaxRate);

              if (balance < grossNeeded) failed = true;

              const tax = Math.max(0, grossNeeded - targetNetNominal);
              const realProfitInWithdrawal = grossNeeded * realProfitRatio;
              const nominalProfitInWithdrawal = grossNeeded * nominalProfitRatio;

              balance -= grossNeeded;
              
              const withdrawalRatio = (balance + grossNeeded > 0) ? (grossNeeded / (balance + grossNeeded)) : 1;
              costBasis *= (1 - withdrawalRatio);
              nominalBasis *= (1 - withdrawalRatio);

              mGross += grossNeeded; 
              mNet += targetNetNominal; 
              mTax += tax;
              mRealProfit += realProfitInWithdrawal;
              mNominalProfit += nominalProfitInWithdrawal;
            }
          }

          schedule.push({
            monthIndex: currentMonthIndex,
            date: formatDate(currentDate),
            deposit: monthlyDeposit,
            balanceStart,
            balanceEnd: balance,
            eventOccurred: eventRef,
            withdrawalGross: mGross > 0 ? mGross : undefined,
            withdrawalNet: mNet > 0 ? mNet : undefined,
            taxPaid: mTax > 0 ? mTax : undefined,
            realProfit: mGross > 0 ? mRealProfit : undefined,
            nominalProfit: mGross > 0 ? mNominalProfit : undefined,
            preWithdrawalBalance: mGross > 0 ? mPreBal : undefined,
            durationInPeriod: i + 1
          });

          if (balance < -1) failed = true;
        }

        return { 
          schedule, 
          finalBalance: balance, 
          finalCostBasis: costBasis, 
          finalNominalBasis: nominalBasis, 
          failed 
        };
      };

      const solveRequiredDeposit = (bal, cb, ncb, start, startIdx, events, params) => {
        if (events.length === 0) return 0;
        let low = 0, high = 20000000, result = high;
        const maxIdx = Math.max(...events.map(e => e.monthOffset));
        const evMap = new Map();
        events.forEach(e => {
          if(!evMap.has(e.monthOffset)) evMap.set(e.monthOffset, []);
          evMap.get(e.monthOffset).push(e);
        });

        for (let i = 0; i < 25; i++) {
          const mid = (low + high) / 2;
          const sim = runSimulationPeriod(bal, cb, ncb, start, startIdx, maxIdx - startIdx + 1, mid, params, evMap);
          if (sim.failed) low = mid; else { result = mid; high = mid; }
        }
        return Math.ceil(result / 10) * 10;
      };

      const calculateSavingsPlan = (params, events) => {
        const sorted = [...events].sort((a,b) => a.monthOffset - b.monthOffset);
        if (sorted.length === 0) {
          return { success: true, schedule: [], finalBalance: params.initialCapital, totalDeposited: 0, totalTaxPaid: 0, totalWithdrawnNet: 0 };
        }

        const fullSchedule = [];
        let curBal = params.initialCapital, curCB = params.initialCapital, curNCB = params.initialCapital;
        let curMonth = 0;
        let maxDepConstraint = Infinity; 
        
        const eventMonths = Array.from(new Set(sorted.map(e => e.monthOffset))).sort((a,b) => a-b);

        for (const mIdx of eventMonths) {
          const rem = sorted.filter(e => e.monthOffset >= curMonth);
          const requiredForFuture = solveRequiredDeposit(curBal, curCB, curNCB, addMonths(new Date(params.startDate), curMonth), curMonth, rem, params);
          
          let deposit = Math.min(requiredForFuture, maxDepConstraint);
          maxDepConstraint = deposit;

          const segmentEvents = new Map(); 
          segmentEvents.set(mIdx, sorted.filter(e => e.monthOffset === mIdx));
          
          const sim = runSimulationPeriod(curBal, curCB, curNCB, addMonths(new Date(params.startDate), curMonth), curMonth, mIdx - curMonth + 1, deposit, params, segmentEvents);
          
          fullSchedule.push(...sim.schedule);
          curBal = sim.finalBalance; curCB = sim.finalCostBasis; curNCB = sim.finalNominalBasis;
          curMonth = mIdx + 1;
        }

        return {
          success: !fullSchedule.some(s => s.balanceEnd < -1),
          schedule: fullSchedule,
          finalBalance: curBal,
          totalDeposited: fullSchedule.reduce((a, s) => a + s.deposit, 0),
          totalTaxPaid: fullSchedule.reduce((a, s) => a + (s.taxPaid || 0), 0),
          totalWithdrawnNet: fullSchedule.reduce((a, s) => a + (s.withdrawalNet || 0), 0)
        };
      };

      const App = () => {
        const [params, setParams] = useState({ 
          startDate: new Date().toISOString().split('T')[0], 
          annualReturn: 7, 
          annualInflation: 2, 
          capitalGainsTax: 25, 
          initialCapital: 0 
        });
        const [events, setEvents] = useState([]);
        const [simulation, setSimulation] = useState(null);
        const [isCalculating, setIsCalculating] = useState(false);
        const fileRef = useRef(null);

        const handleCalculate = () => {
          setIsCalculating(true);
          setTimeout(() => {
            setSimulation(calculateSavingsPlan(params, events));
            setIsCalculating(false);
          }, 400);
        };

        const handleAdd = () => {
          const lastOffset = events.length ? Math.max(...events.map(e => e.monthOffset)) : 0;
          setEvents([...events, { 
            id: generateId(), 
            name: `××™×¨×•×¢ ${events.length + 1}`, 
            targetAmount: 10000, 
            monthOffset: lastOffset + 12 
          }]);
        };

        const handleUpd = (id, f, v) => setEvents(events.map(e => e.id === id ? {...e, [f]: v} : e));
        const handleDel = (id) => setEvents(events.filter(e => e.id !== id));
        
        const dateOptions = useMemo(() => {
          const start = new Date(params.startDate);
          return Array.from({ length: 481 }, (_, i) => {
            const d = addMonths(start, i);
            const y = Math.floor(i/12), m = i%12;
            const diff = i === 0 ? "×”×—×•×“×©" : `${y > 0 ? y + ' ×©\'' : ''} ${m > 0 ? m + ' ×—\'' : ''}`.trim();
            return { v: i, l: `${d.getMonth() + 1}/${d.getFullYear()} (${diff})` };
          });
        }, [params.startDate]);

        return (
          <div className="min-h-screen pb-20">
            <header className="bg-white/80 glass sticky top-0 z-50 border-b border-slate-200">
              <div className="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row items-center justify-between gap-4">
                <div className="flex items-center gap-3">
                  <div className="bg-emerald-600 p-2.5 rounded-2xl text-white shadow-lg shadow-emerald-200">
                    <Calculator size={24} strokeWidth={2.5} />
                  </div>
                  <div>
                    <h1 className="text-xl font-black text-slate-800 tracking-tight leading-tight">××—×©×‘×•×Ÿ ×—×™×¡×›×•×Ÿ ××©×¤×—×ª×™</h1>
                    <p className="text-[10px] font-bold text-emerald-600 uppercase tracking-widest">Smart Wealth Planning</p>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  <button onClick={() => { 
                    const data = { params, events };
                    const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = 'family-savings.json'; a.click();
                  }} className="text-xs font-bold text-slate-600 px-4 py-2 rounded-xl hover:bg-slate-100 transition flex items-center gap-2">
                    <Download size={14} /> ×™×™×¦×•× ×ª×•×›× ×™×ª
                  </button>
                  <button onClick={() => fileRef.current.click()} className="text-xs font-bold text-slate-600 px-4 py-2 rounded-xl hover:bg-slate-100 transition flex items-center gap-2">
                    <Upload size={14} /> ×˜×¢×™× ×”
                  </button>
                  <input type="file" ref={fileRef} className="hidden" onChange={(e) => {
                    const f = e.target.files[0]; if(!f) return;
                    const r = new FileReader(); r.onload = (ev) => {
                      try { const d = JSON.parse(ev.target.result); setParams(d.params); setEvents(d.events); setSimulation(null); } catch(e) { alert('×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ'); }
                    }; r.readAsText(f);
                  }} />
                </div>
              </div>
            </header>

            <main className="max-w-7xl mx-auto px-6 mt-8 space-y-8">
              {/* Top Settings Section (Moved above events) */}
              <section className="bg-white rounded-3xl p-7 border border-slate-200 card-shadow">
                <div className="flex items-center gap-2 mb-6 text-emerald-600">
                  <Settings size={20} strokeWidth={2.5} />
                  <h2 className="text-lg font-black text-slate-800">×”×’×“×¨×•×ª ×”×—×™×¡×›×•×Ÿ ×•×”×©×§×¢×”</h2>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 items-end">
                  <div className="space-y-1.5">
                    <label className="text-[11px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1.5"><Calendar size={12}/> ×ª××¨×™×š ×”×ª×—×œ×”</label>
                    <input type="date" value={params.startDate} onChange={e => setParams({...params, startDate: e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 text-sm font-bold focus:outline-none focus:ring-4 focus:ring-emerald-500/10 transition-all" />
                  </div>
                  <div className="space-y-1.5">
                    <label className="text-[11px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1.5"><TrendingUp size={12}/> ×ª×©×•××” ×©× ×ª×™×ª (%)</label>
                    <input type="number" step="0.1" value={params.annualReturn} onChange={e => setParams({...params, annualReturn: +e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 text-sm font-bold" />
                  </div>
                  <div className="space-y-1.5">
                    <label className="text-[11px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1.5"><Activity size={12}/> ××™× ×¤×œ×¦×™×” (%)</label>
                    <input type="number" step="0.1" value={params.annualInflation} onChange={e => setParams({...params, annualInflation: +e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 text-sm font-bold" />
                  </div>
                  <div className="space-y-1.5">
                    <label className="text-[11px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1.5"><Percent size={12}/> ××¡ ×¨×•×•×— ×”×•×Ÿ</label>
                    <input type="number" value={params.capitalGainsTax} onChange={e => setParams({...params, capitalGainsTax: +e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 text-sm font-bold" />
                  </div>
                  <div className="space-y-1.5">
                    <label className="text-[11px] font-black text-slate-400 uppercase tracking-widest flex items-center gap-1.5"><Wallet size={12}/> ×”×•×Ÿ ×”×ª×—×œ×ª×™</label>
                    <input type="number" step="1000" value={params.initialCapital} onChange={e => setParams({...params, initialCapital: +e.target.value})} className="w-full bg-slate-50 border border-slate-200 rounded-2xl p-4 text-sm font-bold" />
                  </div>
                </div>
              </section>

              <div className="grid grid-cols-1 gap-8">
                {/* Events Section */}
                <section className="bg-white rounded-3xl p-7 border border-slate-200 card-shadow h-full flex flex-col">
                  <div className="flex items-center justify-between mb-8">
                    <div className="flex items-center gap-2">
                      <CalendarCheck size={20} className="text-blue-600" />
                      <h2 className="text-lg font-black text-slate-800">××™×¨×•×¢×™× ×•××©×™×›×•×ª ××ª×•×›× × ×•×ª</h2>
                    </div>
                    <div className="flex gap-4 items-center">
                      <button onClick={handleAdd} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-2xl text-xs font-black flex items-center gap-2 transition-all shadow-lg shadow-blue-100 active:scale-95">
                        <Plus size={18} strokeWidth={3} /> ×”×•×¡×£ ××™×¨×•×¢
                      </button>
                      <button onClick={handleCalculate} disabled={isCalculating} className="btn-primary text-white font-black py-3 px-8 rounded-2xl shadow-xl shadow-emerald-100 flex items-center justify-center gap-3 disabled:opacity-50 active:scale-95">
                        {isCalculating ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> : <><Sparkles size={20} /> ×—×©×‘ ×ª×•×›× ×™×ª</>}
                      </button>
                    </div>
                  </div>
                  <div className="flex-1 space-y-4 overflow-y-auto max-h-[600px] pr-2">
                    {events.length === 0 ? (
                      <div className="h-full flex flex-col items-center justify-center text-center py-20 bg-slate-50/50 rounded-[2rem] border-2 border-dashed border-slate-200">
                        <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-4 text-slate-300 shadow-sm">
                          <Info size={32} />
                        </div>
                        <p className="text-slate-400 font-bold max-w-[220px]">×”×•×¡×™×¤×• ××™×¨×•×¢×™× ××©×¤×—×ª×™×™× (×—×ª×•× ×”, ×‘×¨ ××¦×•×•×”, ×¨×›×™×©×” ×’×“×•×œ×”) ×›×“×™ ×œ×ª×›× ×Ÿ ××ª ×”××©×™×›×•×ª.</p>
                      </div>
                    ) : (
                      events.map((e) => {
                        const inflation = getMonthlyRate(params.annualInflation);
                        const adjusted = e.targetAmount * Math.pow(1 + inflation, e.monthOffset);
                        return (
                          <div key={e.id} className="animate-slide-in relative bg-slate-50 border border-slate-100 rounded-3xl p-6 hover:border-emerald-200 transition-all group grid grid-cols-1 md:grid-cols-12 gap-6 items-end shadow-sm">
                            <button onClick={() => handleDel(e.id)} className="absolute top-4 left-4 text-slate-300 hover:text-rose-500 transition opacity-0 group-hover:opacity-100">
                              <Trash2 size={18}/>
                            </button>
                            <div className="md:col-span-4 space-y-2">
                              <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">×©× ×”××™×¨×•×¢</label>
                              <input type="text" value={e.name} onChange={x => handleUpd(e.id, 'name', x.target.value)} className="w-full bg-white border border-slate-200 rounded-2xl p-3 text-sm font-bold" />
                            </div>
                            <div className="md:col-span-4 space-y-2">
                              <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">××•×¢×“ ××©×™×›×”</label>
                              <div className="relative">
                                <select value={e.monthOffset} onChange={x => handleUpd(e.id, 'monthOffset', +x.target.value)} className="w-full bg-white border border-slate-200 rounded-2xl p-3 text-sm font-bold appearance-none">
                                  {dateOptions.map(o => <option key={o.v} value={o.v}>{o.l}</option>)}
                                </select>
                                <ChevronDown className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none" size={16} />
                              </div>
                            </div>
                            <div className="md:col-span-2 space-y-2">
                              <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">×¡×›×•× × ×˜×• (×”×™×•×)</label>
                              <input type="number" step="1000" value={e.targetAmount} onChange={x => handleUpd(e.id, 'targetAmount', +x.target.value)} className="w-full bg-white border border-slate-200 rounded-2xl p-3 text-sm font-bold" />
                            </div>
                            <div className="md:col-span-2 text-left pb-1">
                              <p className="text-[10px] font-black text-slate-300 uppercase leading-none mb-1">×¡×›×•× ××ª×•×× ××“×“</p>
                              <p className="text-sm font-black text-emerald-600">{formatCurrency(adjusted)}</p>
                            </div>
                          </div>
                        );
                      })
                    )}
                  </div>
                </section>
              </div>

              {simulation && (
                <div className="mt-12 space-y-12 animate-in fade-in slide-in-from-bottom-6 duration-700">
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div className="md:col-span-2 bg-white rounded-[2.5rem] p-10 border border-slate-200 card-shadow flex flex-col justify-between relative overflow-hidden group">
                      <Sparkles className="absolute -top-10 -right-10 w-40 h-40 text-emerald-500/5 group-hover:text-emerald-500/10 transition-all duration-1000" />
                      <div className="flex items-center gap-2 text-emerald-600 mb-6 font-black uppercase tracking-widest text-[11px]">
                        <TrendingUp size={16} /> ×”×¤×§×“×” ×—×•×“×©×™×ª ××•××œ×¦×ª
                      </div>
                      <div>
                        <h3 className="text-6xl font-black mb-2 text-slate-900">{formatCurrency(simulation.schedule[0]?.deposit || 0)}</h3>
                        <p className="text-slate-400 text-sm font-bold leading-relaxed max-w-[400px]">
                          ×–×”×• ×”×¡×›×•× ×”××¨×‘×™ ×©×¢×œ×™×›× ×œ×”×¤×§×™×“. ×’×•×‘×” ×”×”×¤×§×“×” ×¢×©×•×™ <span className="text-emerald-600">×œ×¨×“×ª</span> ×œ××—×¨ ×¤×§×™×¢×ª ××™×¨×•×¢×™×, ××š ×œ×¢×•×œ× ×œ× ×™×¢×œ×”.
                        </p>
                      </div>
                    </div>
                    <div className="bg-white rounded-[2.5rem] p-10 border border-slate-200 card-shadow flex flex-col justify-center">
                      <p className="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-2">×™×ª×¨×” ×¡×•×¤×™×ª</p>
                      <h3 className="text-4xl font-black text-blue-600">{formatCurrency(simulation.finalBalance)}</h3>
                      <div className="mt-6 flex items-center gap-2 text-[10px] text-slate-400 font-bold">
                        <Activity size={12} /> ×™×ª×¨×” ×œ××—×¨ ×›×œ ×”××©×™×›×•×ª
                      </div>
                    </div>
                    <div className="bg-white rounded-[2.5rem] p-10 border border-slate-200 card-shadow flex flex-col justify-center">
                      <p className="text-[11px] font-black text-slate-400 uppercase tracking-widest mb-2">×¡×”"×› ×”×¤×§×“×•×ª</p>
                      <h3 className="text-4xl font-black text-slate-700">{formatCurrency(simulation.totalDeposited)}</h3>
                      <div className="mt-6 flex items-center gap-2 text-[10px] text-slate-400 font-bold">
                        <Wallet size={12} /> ×¡×”"×› ×”×•×Ÿ ×¢×¦××™ ××•×©×§×¢
                      </div>
                    </div>
                  </div>

                  <section className="bg-white p-10 rounded-[3rem] border border-slate-200 card-shadow">
                    <div className="flex items-center justify-between mb-10">
                      <div>
                        <h3 className="text-xl font-black text-slate-800">×’×¨×£ ×¦×‘×™×¨×ª ×”×•×Ÿ</h3>
                        <p className="text-slate-400 text-xs font-bold mt-1">×¦×‘×™×¨×” ×—×•×“×©×™×ª, ×”×¤×§×“×•×ª ×•× ×§×•×“×•×ª ××©×™×›×” ×œ××•×¨×š ×”×©× ×™×</p>
                      </div>
                      <div className="flex gap-4">
                        <div className="flex items-center gap-2 text-[10px] font-black text-slate-500"><div className="w-3 h-3 bg-emerald-500 rounded-full"></div> ×™×ª×¨×”</div>
                        <div className="flex items-center gap-2 text-[10px] font-black text-slate-500"><div className="w-3 h-3 bg-blue-500/20 border-2 border-blue-500 rounded-full"></div> ×”×¤×§×“×”</div>
                      </div>
                    </div>
                    <div className="h-[450px]">
                      <ResponsiveContainer width="100%" height="100%">
                        <AreaChart data={simulation.schedule} margin={{ top: 20, right: 10, left: 10, bottom: 0 }}>
                          <defs>
                            <linearGradient id="colorBal" x1="0" y1="0" x2="0" y2="1">
                              <stop offset="5%" stopColor="#10b981" stopOpacity={0.15}/>
                              <stop offset="95%" stopColor="#10b981" stopOpacity={0}/>
                            </linearGradient>
                          </defs>
                          <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                          <XAxis dataKey="date" interval={Math.floor(simulation.schedule.length/8)} tick={{fontSize: 10, fontWeight: 700, fill: '#94a3b8'}} axisLine={false} tickLine={false} />
                          <YAxis tickFormatter={v => formatCurrency(v).replace('â‚ª','')} tick={{fontSize: 10, fontWeight: 700, fill: '#94a3b8'}} axisLine={false} tickLine={false} />
                          <Tooltip 
                            contentStyle={{ borderRadius: '24px', border: 'none', boxShadow: '0 20px 40px -10px rgba(0,0,0,0.1)', direction: 'rtl', padding: '16px' }} 
                            formatter={v => [formatCurrency(v), ""]} 
                          />
                          <Area type="monotone" dataKey="balanceEnd" name="×™×ª×¨×”" stroke="#10b981" fill="url(#colorBal)" strokeWidth={4} animationDuration={1500} />
                          <Area type="stepAfter" dataKey="deposit" name="×”×¤×§×“×”" stroke="#3b82f6" fill="rgba(59, 130, 246, 0.05)" strokeWidth={2} strokeDasharray="5 5" />
                          {simulation.schedule.filter(s => s.eventOccurred).map((s, i) => (
                            <ReferenceLine key={i} x={s.date} stroke="#f43f5e" strokeDasharray="8 8" label={{ position: 'top', value: 'ğŸ“', fill: '#f43f5e', fontSize: 20 }} />
                          ))}
                        </AreaChart>
                      </ResponsiveContainer>
                    </div>
                  </section>

                  <section className="bg-white rounded-[3rem] border border-slate-200 card-shadow overflow-hidden">
                    <div className="p-10 border-b border-slate-100 flex items-center justify-between">
                      <h3 className="text-xl font-black text-slate-800">×¤×™×¨×•×˜ ×ª×§×•×¤×•×ª ×•××©×™×›×•×ª</h3>
                      {!simulation.success && (
                        <div className="bg-rose-50 text-rose-600 px-4 py-2 rounded-xl flex items-center gap-2 text-xs font-bold animate-pulse">
                          <AlertCircle size={16} /> ×”×—×™×¡×›×•×Ÿ ××™× ×• ××¡×¤×™×§ ×œ×›×œ ×”××©×™×›×•×ª
                        </div>
                      )}
                    </div>
                    <div className="overflow-x-auto">
                      <table className="w-full text-right border-collapse">
                        <thead className="bg-slate-50/50 text-slate-400 text-[10px] font-black uppercase tracking-widest">
                          <tr>
                            <th className="p-8">×¤×™×¨×•×˜ ×”××™×¨×•×¢ / ×ª×§×•×¤×”</th>
                            <th className="p-8">×ª××¨×™×š / ××©×š</th>
                            <th className="p-8">××©×™×›×ª ×‘×¨×•×˜×•</th>
                            <th className="p-8">×¨×•×•×— × ×•××™× ×œ×™</th>
                            <th className="p-8">×¨×•×•×— ×¨×™××œ×™</th>
                            <th className="p-8">××¡ (×¨×™××œ×™)</th>
                            <th className="p-8 text-emerald-600">× ×˜×• ×‘×™×“</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                          {simulation.schedule.filter(s => s.withdrawalGross).map((item, idx) => {
                            // Find months since previous event or start
                            const eventsBefore = simulation.schedule.filter((s, i) => s.withdrawalGross && i < simulation.schedule.indexOf(item));
                            const lastEventIdx = eventsBefore.length > 0 ? simulation.schedule.indexOf(eventsBefore[eventsBefore.length-1]) : -1;
                            const monthsInPeriod = simulation.schedule.indexOf(item) - lastEventIdx;

                            return (
                              <React.Fragment key={idx}>
                                {/* Period Row */}
                                <tr className="bg-slate-50/30 border-r-4 border-r-blue-400">
                                  <td className="p-4 px-8 text-xs font-bold text-slate-500 flex items-center gap-2">
                                    <Clock size={14} className="text-blue-400" />
                                    ×ª×§×•×¤×ª ×—×™×¡×›×•×Ÿ
                                  </td>
                                  <td className="p-4 px-8 text-xs font-bold text-slate-600">
                                    {monthsInPeriod} ×—×•×“×©×™×
                                  </td>
                                  <td colSpan="4" className="p-4 px-8 text-xs font-bold text-slate-600">
                                    ×”×¤×§×“×” ×—×•×“×©×™×ª ×‘×ª×§×•×¤×” ×–×•: <span className="text-blue-600">{formatCurrency(item.deposit)}</span> 
                                    <span className="mx-4">|</span>
                                    ×”×•×Ÿ ×¦×‘×•×¨ ×œ×¤× ×™ ××©×™×›×”: <span className="text-slate-900">{formatCurrency(item.preWithdrawalBalance)}</span>
                                  </td>
                                  <td></td>
                                </tr>
                                {/* Event Row */}
                                <tr className="hover:bg-emerald-50/20 transition-colors">
                                  <td className="p-8 font-black text-slate-900">
                                    <div className="flex flex-col">
                                      <span>{item.eventOccurred?.name}</span>
                                      <span className="text-[10px] text-slate-400 font-bold mt-1">××©×™×›×” ××ª×•×›× × ×ª</span>
                                    </div>
                                  </td>
                                  <td className="p-8 text-slate-500 font-bold">{item.date}</td>
                                  <td className="p-8 text-slate-700 font-bold">{formatCurrency(item.withdrawalGross || 0)}</td>
                                  <td className="p-8 text-slate-600 font-bold">{formatCurrency(item.nominalProfit || 0)}</td>
                                  <td className="p-8 text-slate-600 font-bold">{formatCurrency(item.realProfit || 0)}</td>
                                  <td className="p-8 text-rose-500 font-bold">-{formatCurrency(item.taxPaid || 0)}</td>
                                  <td className="p-8 text-emerald-600 font-black text-2xl leading-none">{formatCurrency(item.withdrawalNet || 0)}</td>
                                </tr>
                              </React.Fragment>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  </section>
                </div>
              )}
            </main>

            <footer className="max-w-7xl mx-auto px-6 mt-16 text-center">
              <p className="text-slate-300 text-[10px] font-black uppercase tracking-widest mb-3">Family Savings Planner Â© 2026</p>
              <div className="flex justify-center gap-6 text-slate-400 text-[11px] font-medium italic">
                <span>×ª×›× ×•×Ÿ ×—×›×</span> â€¢ <span>×¢×ª×™×“ ×‘×˜×•×—</span> â€¢ <span>××©×¤×—×” ×××•×©×¨×ª</span>
              </div>
            </footer>
          </div>
        );
      };

      const container = document.getElementById('root');
      if (container) {
        const root = createRoot(container);
        root.render(<App />);
      }
    </script>
  </body>
</html>
